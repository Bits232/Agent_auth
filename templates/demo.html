<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agent Auth ‚Äî Live Security Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .result-safe { background: #ECFDF5; color: #065F46; }
    .result-flag { background: #FEF3F2; color: #991B1B; }
    .result-neutral { background: #F3F4F6; color: #374151; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-50 to-indigo-50 flex items-center justify-center p-6">

<main class="w-full max-w-3xl">
  <section class="bg-white rounded-3xl shadow-xl p-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Agent Auth ‚Äî Live Security Demo</h1>
      <small class="text-sm text-gray-500">Powered by pg_textsearch BM25 + AI</small>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <form id="loginForm" class="space-y-4" onsubmit="return handleSubmit(event)">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input id="email" name="email" type="email" autocomplete="email"
                 class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400"
                 placeholder="test@example.com" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password / Input to test</label>
          <input id="password" name="password" type="text" autocomplete="current-password"
                 class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-400"
                 placeholder="Type something (try: OR 1=1 or <script>)" />
          <p class="text-xs text-gray-400 mt-1">This field is analyzed live for malicious content.</p>
        </div>

        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-sky-600 text-white py-2 rounded-lg hover:bg-sky-700">
            Sign In (simulate)
          </button>
          <button type="button" id="safeBtn" class="bg-white border py-2 px-4 rounded-lg" onclick="fillSafe()">
            Fill Safe
          </button>
          <button type="button" id="attackBtn" class="bg-white border py-2 px-4 rounded-lg" onclick="fillAttack()">
            Fill Attack
          </button>
        </div>
      </form>

      <aside class="bg-gray-50 rounded-xl p-4">
        <h3 class="text-sm font-semibold text-gray-800 mb-3">üîç Live Security Analysis</h3>

        <div id="statusBadge" class="result-neutral rounded-md px-3 py-2 mb-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span id="statusIcon" class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
              <div>
                <div id="statusTitle" class="text-sm font-medium text-gray-800">Idle</div>
                <div id="statusSubtitle" class="text-xs text-gray-500">Type in the form to analyze</div>
              </div>
            </div>
            <div class="text-xs text-gray-400" id="systemsActive">pg_textsearch BM25</div>
          </div>
        </div>

        <div id="threatList" class="space-y-2 max-h-48 overflow-auto">
          <div class="text-xs text-gray-500">No analysis yet.</div>
        </div>

        <div class="mt-3 text-xs text-gray-400">
          <strong>Tip:</strong> Try inputs like <code>OR 1=1</code>, <code>UNION SELECT</code>, or <code>&lt;script&gt;</code>.
        </div>
      </aside>
    </div>
  </section>
</main>

<script>
  function getCookie(name) {
    const matches = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return matches ? decodeURIComponent(matches[2]) : null;
  }
  const CSRF_TOKEN = getCookie('csrftoken');

  const emailInput = document.getElementById('email');
  const pwdInput = document.getElementById('password');
  const statusBadge = document.getElementById('statusBadge');
  const statusIcon = document.getElementById('statusIcon');
  const statusTitle = document.getElementById('statusTitle');
  const statusSubtitle = document.getElementById('statusSubtitle');
  const threatList = document.getElementById('threatList');
  const systemsActive = document.getElementById('systemsActive');

  function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} }

  pwdInput.addEventListener('input', debounce(async (e) => {
    const v = e.target.value || '';
    if (!v.trim()) { showIdle(); return; }
    showAnalyzing(v);
    const res = await analyzeSecurity(v);
    renderResults(res);
  }, 300));

  emailInput.addEventListener('input', debounce(async (e) => {
    const v = e.target.value || '';
    if (!v.trim()) return;
    const res = await analyzeSecurity(v);
    renderResults(res);
  }, 500));

  async function analyzeSecurity(inputText){
    try {
      const r = await fetch('/live-security-analysis/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({ input: inputText })
      });
      if(!r.ok) throw new Error('Network response not OK');
      return await r.json();
    } catch(err) {
      return { error: String(err) };
    }
  }

  function showIdle(){
    statusBadge.className = 'result-neutral rounded-md px-3 py-2 mb-3';
    statusIcon.style.background = '#9CA3AF';
    statusTitle.textContent = 'Idle';
    statusSubtitle.textContent = 'Type in the form to analyze';
    threatList.innerHTML = '<div class="text-xs text-gray-500">No analysis yet.</div>';
  }

  function showAnalyzing(input){
    statusBadge.className = 'result-neutral rounded-md px-3 py-2 mb-3';
    statusIcon.style.background = '#60A5FA';
    statusTitle.textContent = 'Analyzing';
    statusSubtitle.textContent = `pg_textsearch processing: "${escapeHtml(input).slice(0,40)}${input.length>40?'...':''}"`;
    threatList.innerHTML = `<div class="text-xs text-gray-500">Analyzing input‚Ä¶</div>`;
  }

  function parseSeverityValue(sev){
    const map = { low:1, medium:2, high:3, critical:4 };
    if (sev === null || sev === undefined) return 2; // default medium if absent
    if (typeof sev === 'string') return map[sev.toLowerCase()] || 2;
    const n = Number(sev);
    return Number.isFinite(n) ? Math.max(0, Math.min(4, n)) : 2;
  }

  function renderResults(res){
    if(res.error){
      statusBadge.className = 'result-flag rounded-md px-3 py-2 mb-3';
      statusIcon.style.background = '#DC2626';
      statusTitle.textContent = 'Error';
      statusSubtitle.textContent = res.error;
      threatList.innerHTML = `<div class="text-xs text-red-600">${escapeHtml(res.error)}</div>`;
      return;
    }

    const threats = res.threats || [];
    systemsActive.textContent = (res.systems_active || ['pg_textsearch']).join(', ');

    // Compute highest severity among threats
    let highestSeverity = 0; // 0 = none
    threats.forEach(t => {
      t.severityValue = parseSeverityValue(t.severity);
      // treat explicit action "flag" as raising concern
      const action = (t.action || '').toLowerCase();
      if (action === 'flag') t.severityValue = Math.max(t.severityValue, 2);
      if (t.severityValue > highestSeverity) highestSeverity = t.severityValue;
    });

    // Top status badge based on highest severity (low=1 -> safe, medium+ -> flag)
    if (threats.length === 0) {
      statusBadge.className = 'result-neutral rounded-md px-3 py-2 mb-3';
      statusIcon.style.background = '#9CA3AF';
      statusTitle.textContent = 'Idle';
      statusSubtitle.textContent = 'No immediate threats detected';
    } else if (highestSeverity <= 1) {
      statusBadge.className = 'result-safe rounded-md px-3 py-2 mb-3';
      statusIcon.style.background = '#10B981';
      statusTitle.textContent = 'Input Safe / Low severity';
      statusSubtitle.textContent = 'Only low-severity issues detected';
    } else {
      statusBadge.className = 'result-flag rounded-md px-3 py-2 mb-3';
      statusIcon.style.background = '#DC2626';
      statusTitle.textContent = 'Threat Detected';
      statusSubtitle.textContent = `${threats.length} issue(s) found ‚Äî review recommended`;
    }

    // Render threat list; low severity = green, medium+ = red
    if (threats.length === 0) {
      threatList.innerHTML = `<div class="text-sm text-green-700 font-medium">No threats</div>`;
    } else {
      threatList.innerHTML = threats.map(t => {
        const score = (t.bm25_score !== null && t.bm25_score !== undefined) ? `Score: ${Number(t.bm25_score).toFixed(3)}` : '';
        const boxClass = t.severityValue >= 2 ? 'result-flag' : 'result-safe';
        return `
          <div class="p-2 border rounded-md ${boxClass}">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold text-gray-800">${escapeHtml(t.pattern)}</div>
                <div class="text-xs text-gray-500 mt-0.5">${escapeHtml(t.type)} ‚Ä¢ Severity: ${escapeHtml(String(t.severity))}</div>
              </div>
              <div class="text-xs text-gray-600 ml-2">${escapeHtml(score)}</div>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'/':'&#x2F;','`':'&#96;','=':'&#61;'}[c])); }

  // Block decision: block if any threat is medium+ or action === 'flag'
  function shouldBlock(threats){
    for(const t of (threats || [])){
      const sev = parseSeverityValue(t.severity);
      const action = (t.action || '').toLowerCase();
      if (sev >= 2 || action === 'flag') return true;
    }
    return false;
  }

  async function handleSubmit(e){
    e.preventDefault();
    const email = emailInput.value || '';
    const pwd = pwdInput.value || '';
    // analyze both fields
    const [r1, r2] = await Promise.all([ analyzeSecurity(email), analyzeSecurity(pwd) ]);

    // gather threats arrays (normalize)
    const threats = [ ...(r1.threats || []), ...(r2.threats || []) ];
    // If analyses returned non-standard single result (like AI JSON object), normalize into array items
    // (backend already returns list in 'threats', so this is just defensive)

    if (!shouldBlock(threats)) {
      alert('‚úÖ Login simulated: No threats detected.');
    } else {
      alert('üö® Blocked: security threats detected. Check the side panel for details.');
    }
  }

  // Fill buttons - now trigger analysis like user typing
  function fillSafe(){
    emailInput.value = 'test@example.com';
    pwdInput.value = 'safePassword1234';
    showAnalyzing(pwdInput.value);
    // analyze both fields and show results for password (and update systemsActive)
    analyzeSecurity(pwdInput.value).then(renderResults);
  }

  function fillAttack(){
    emailInput.value = 'attacker@evil.tld';
    pwdInput.value = 'OR 1=1';
    showAnalyzing(pwdInput.value);
    analyzeSecurity(pwdInput.value).then(renderResults);
  }

  // init
  showIdle();
</script>
</body>
</html>
